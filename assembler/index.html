<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FXCore Assembler</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="data:,">
</head>

<body>
    <div class="container">

        <!-- Monaco Editor Loader -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
        <script src="monaco.js"></script>

        <div class="header-bar">
            <h1>FXCore Assembler <span class="build">build 07</span></h1>
            <img src="icon.png" alt="App Icon" class="app-icon">
        </div>

        <div class="instructions-section">
            <h3 onclick="toggleInstructions()" style="cursor: pointer; user-select: none; margin-bottom: 10px;">
                <span id="instructionsToggle">▶</span> Instructions
            </h3>
            <div id="instructionsContent" class="instructions-content collapsed">
                <div class="instructions-text">
                    <p>Enter FXCore source code into the editor area, or select a file or example.  Press the <b>Assemble</b> button to verify and assemble the code into a HEX file</p>
                    
                    <p>If connecting to a Sandbox hardware unit, use the <b>Select Output Directory</b>b button to specify the path to your Sandbox (typically /CIRCUITPY).  Press the <b>Download HEX</b> button to save the result to your local machine or hardware device.  </p>
                    
                    <p>Press the <b>Clear Hardware</b> button to send a clear message to the Sandbox hardware unit and return to normal operation.</p>
                    
                    <p>When satisfied with your source code, press the <b>Save Source...</b> button to download a local copy.</p>
                </div>
            </div>
        </div>

        <h2>Input Source Code</h2>
        <div class="file-input">
            <input type="file" id="fileInput" accept=".fxc,.fxo,.asm,.txt" style="display: none;" onchange="loadFile()">
            <button onclick="document.getElementById('fileInput').click()">Load File...</button>

            <div class="example-buttons">
                <span>Or select an example program:</span>
                <div class="button-grid">
                    <button onclick="loadExample('fxcore_passthrough')">FXCore Pass-through</button>
                    <button onclick="loadExample('fxcore_delay')">FXCore Delay</button>
                    <button onclick="loadExample('fxcore_chorus')">FXCore Chorus</button>
                </div>
            </div>
        </div>

        <div class="editor-container">
            <div id="editor" style="width: 100%; height: 400px;"></div>
        </div>
        <div class="editor-help-text">
            <label>
                <span class="shortcut">Editor Shortcuts active when cursor is in editor window:</span>
                <span class="shortcut">Ctrl+F / ⌘+F Find</span>
                <span class="shortcut">Ctrl+Shift+F / ⌘+⌥+F Replace</span>
                <span class="shortcut">F3 Find Next</span>
            </label><br>
            <label>
                <span class="shortcut">Editor accepts ASCII text only</span>
            </label>
        </div>

        <div class="options">
            <label>
                <input type="checkbox" id="editorHeightToggle" onchange="toggleEditorHeight()"> Large editor window
            </label>
            <label>
                <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()"> Enable dark mode
            </label>
            <label>
                <input type="checkbox" id="minimapToggle" onchange="toggleMinimap()"> Show editor mini-map
            </label>
        </div>

        <div>
            <button onclick="assembleFXCore()">Assemble</button>
            <button onclick="clearEditor()">Clear Editor</button>
            <button onclick="saveSource()">Save Source...</button>
        </div>

        <div id="messages"></div>

        <div class="output-section">
            <h2>Output</h2>
            <div class="output-controls">
                <div>
                    <button onclick="selectOutputDirectory()" id="selectDirBtn">Select Output Directory</button>
                    <span id="outputDirDisplay" style="margin-left: 10px; color: #666; font-style: italic;">No directory selected</span>
                </div><br>
                <div>
                    <button onclick="downloadHex()" id="downloadHexBtn" disabled>Download HEX</button>
                    <button onclick="clearAssembly()">Clear Assembly</button>
                    <button onclick="clearHardware()">Clear Hardware</button>
                </div>
                </div>
            </div>

            <div class="output-text-section">
                <h3 onclick="toggleOutput()" style="cursor: pointer; user-select: none; margin-bottom: 10px;">
                    <span id="outputToggle">▶</span> Assembly Output
                </h3>
                <div id="outputContent" class="output-content collapsed">
                    <textarea id="output" readonly placeholder="FXCore assembly output will appear here..."></textarea>
                </div>
            </div>
        </div>

        <!-- Modal dialogs for user prompts -->
        <div id="confirmModal" class="modal">
            <div class="modal-content">
                <h3 id="confirmTitle">Confirm Action</h3>
                <p id="confirmMessage">Are you sure you want to proceed?</p>
                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="closeModal('confirmModal')">Cancel</button>
                    <button class="btn-primary" id="confirmOkBtn">OK</button>
                </div>
            </div>
        </div>

        <div id="threeChoiceModal" class="modal">
            <div class="modal-content">
                <h3 id="threeChoiceTitle">Unsaved Changes</h3>
                <p id="threeChoiceMessage">You have unsaved changes. What would you like to do?</p>
                <div class="modal-buttons">
                    <button class="btn-secondary" id="threeChoiceCancelBtn">Cancel</button>
                    <button class="btn-danger" id="threeChoiceDiscardBtn">Discard</button>
                    <button class="btn-primary" id="threeChoiceSaveBtn">Save</button>
                </div>
            </div>
        </div>

        <div id="inputModal" class="modal">
            <div class="modal-content">
                <h3 id="inputTitle">Input Required</h3>
                <label for="modalInput" id="inputLabel">Please enter a value:</label>
                <input type="text" id="modalInput" placeholder="Enter value...">
                <div class="modal-buttons">
                    <button class="btn-secondary" onclick="closeModal('inputModal')">Cancel</button>
                    <button class="btn-primary" id="inputOkBtn">OK</button>
                </div>
            </div>
        </div>

        <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 11px; color: #666; line-height: 1.4;">
            <p><strong>MIT License</strong></p>
            <p>FXCore Sandbox Editor by Disaster Area Designs, <a href="https://github.com/DisasterAreaDesigns/Sandbox-FXCore" style="color: #666;">https://github.com/DisasterAreaDesigns/Sandbox-FXCore</a><br>
                Copyright (c) 2025-present by Disaster Area Designs LLC</p>
            <p>Uses portions of fxcoreasmlite by Experimental Noize, <a href="https://experimentalnoize.com" style="color: #666;">https://experimentalnoize.com</a><br>
                Copyright (c) 2019-present Experimental Noize</p>
            <p>Uses monaco-editor by Microsoft, <a href="https://github.com/microsoft/monaco-editor" style="color: #666;">https://github.com/microsoft/monaco-editor</a><br>
                Copyright (c) 2016-present Microsoft Corporation</p>
            <p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
                SOFTWARE.</p>
        </footer>

        <!-- FXCore Assembler Scripts -->
        <script src="ui.js"></script>
        <script src="examples.js"></script>
        <script src="debug_config.js"></script>
        <script src="common.js"></script>
        <script src="reserved_words.js"></script>
        <script src="registers.js"></script>
        <script src="mnemonic.js"></script>
        <script src="shunting_yard.js"></script>
        <script src="line_parse.js"></script>
        <script src="intel_hex.js"></script>
        <script src="symbol_table.js"></script>
        <script src="fxcore_ic.js"></script>
        <script src="assembler.js"></script>
        <script src="program.js"></script>

        <script>
        // Global variables and functions to integrate FXCore with Monaco editor
        let assembledData = null;

        // Add listener for system dark mode changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle && editor) {
                darkModeToggle.checked = e.matches;
                const theme = e.matches ? 'fxcoreDark' : 'fxcoreTheme';
                monaco.editor.setTheme(theme);
                document.body.classList.toggle('dark-mode', e.matches);
            }
        });

        // Initialize the FXCore assembler when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            DEBUG.reset();
            // DEBUG.setPreset('full');
            DEBUG.showConfig();

            // Override FXCoreAssembler.logMessage to work with our DOM structure
            if (typeof FXCoreAssembler !== 'undefined') {
                FXCoreAssembler.logMessage = function(message, type = 'info') {
                    const timestamp = new Date().toLocaleTimeString();
                    const outputArea = document.getElementById('output');
                    const messagesArea = document.getElementById('messages');

                    // Log to console for debugging
                    console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
                };
            }

            console.log('FXCore assembler libraries loaded');
        });
        </script>
    </div>
</body>

</html>
