<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sandbox FXCore Editor</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,0,1;wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">

        <!-- Monaco Editor Loader -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
        <script src="monaco.js"></script>

        <div class="header-bar">
            <div class="header-content">
                <h1>Sandbox FXCore Editor</h1>
            </div>
            <div class="icon-container">
                <a href="https://sandboxpedal.com" target="_blank" rel="noopener noreferrer">
                    <svg class="app-icon" width="64" height="64" viewBox="0 0 64 64">
                        <rect width="64" height="64"  rx="4" ry="4" fill="currentColor"/>
                        <text x="32" y="40"text-anchor="middle" fill="white" font-family="League Spartan" font-size="20" font-weight="bold">FXC</text>
                    </svg>
                </a>
                <span class="build">build 14</span>
            </div>
        </div>
        <h2>Source Input</h2>
        <div class="file-input">
            <input type="file" id="fileInput" accept=".fxc,.fxo,.asm,.txt" style="display: none;" onchange="handleFileInputChange()">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button onclick="loadFile()">Load File...</button>

                <div style="display: flex; align-items: center; gap: 10px;">
                    <span>Or select an example program:</span>
                    <button onclick="loadExample('fxcore_passthrough')">Pass-through</button>
                    <button onclick="loadExample('fxcore_blink')">LED Blink</button>
                    <button onclick="loadExample('fxcore_delay')">Delay</button>
                    <button onclick="loadExample('fxcore_chorus')">Chorus</button>
                </div>
            </div>
        </div>

        <div class="editor-container">
            <div id="editor" style="width: 100%; height: 400px;"></div>
        </div>

        <!-- Editor Options Section -->
        <div class="editor-options-section">
            <h3 onclick="toggleEditorOptions()" style="cursor: pointer; user-select: none; margin-bottom: 10px;">
                <span id="editorOptionsToggle">▶</span> Editor Options
            </h3>
            <div id="editorOptionsContent" class="editor-options-content collapsed">
                <div class="options">
                    <div class="project-folder-section">
                        <button id="projectFolderBtn" class="project-folder-button" onclick="selectProjectDirectory()">
                            Select Project Folder
                        </button>
                        <span id="projectFolderLabel" style="margin-left: 10px; color: #666; font-style: italic;">No directory selected</span>
                    </div><br>
                    <label>
                        <input type="checkbox" id="editorHeightToggle" onchange="toggleEditorHeightWithSave()"> Large editor window
                    </label>
                    <label>
                        <input type="checkbox" id="minimapToggle" onchange="toggleMinimapWithSave()"> Show editor mini-map
                    </label>
                    <label>
                        <input type="checkbox" id="debugToggle" onchange="toggleDebugPresetWithSave()"> Show full build results
                    </label>
                    <label>
                        <label>
                            Theme: 
                            <select id="darkModeSelect">
                                <option value="system">System</option>
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                            </select>
                        </label>
                    </label>
                </div>
                <div class="editor-help-text">
                    <label>
                        <span class="shortcut">Editor Shortcuts active when cursor is in editor window:</span>
                        <span class="shortcut">Ctrl+F / ⌘+F Find</span>
                        <span class="shortcut">Ctrl+Shift+F / ⌘+⌥+F Replace</span>
                        <span class="shortcut">F3 Find Next</span>
                    </label><br>
                    <label>
                        <span class="shortcut">Editor accepts ASCII text only</span>
                    </label>
                </div>
            </div>
        </div>

        <div>
            <button onclick="assembleFXCore()">Assemble</button>
            <button onclick="downloadPlainHex()" id="downloadPlainHexBtn" disabled>Download HEX</button>
            <button onclick="downloadCHeader()" id="downloadCHeaderBtn" disabled>Download C Headers</button>
            <button onclick="saveSource()">Save Source...</button>
            <div style="float: right;">
                <button onclick="clearEditor()">Clear Editor</button>
            </div>
        </div>

        <h2>Build Results</h2>
        <div id="messages" style="display: block; min-height: 100px;"></div>

        <!-- Hardware Options Section -->
        <div class="hardware-options-section">
            <h3 onclick="toggleHardwareOptions()" style="cursor: pointer; user-select: none; margin-bottom: 10px;">
                <span id="hardwareOptionsToggle">▶</span> Hardware Options
                <span id="hardwareConnectionStatus" style="font-weight: normal; color: #666; margin-left: 10px; font-size: 0.9em;">No connection</span>
            </h3>
            <div id="hardwareOptionsContent" class="hardware-options-content collapsed">
                <div class="output-controls">
                    <div>
                        <button onclick="cycleHWModeWithSave()" id="HWModeBtn">Select Hardware Mode</button>
                        <span id="HWModeDisplay" style="margin-left: 10px; color: #666; font-style: italic;">HID mode</span>
                    </div><br />
                    <div id="FileModeDiv" style="display: none;">
                        <div>
                            <button onclick="selectOutputDirectory()" id="selectDirBtn">Select Output Directory</button>
                            <span id="outputDirDisplay" style="margin-left: 10px; color: #666; font-style: italic;">No directory selected</span>
                        </div><br />
                        <div>
                            <button onclick="serialConnect()">Select Serial Port</button>
                            <span id="serialPortDisplay" style="margin-left: 10px; color: #666; font-style: italic;">No port selected</span>
                        </div><br />
                        <div>
                            <button onclick="cycleProgramTargetWithSave()" id="programTargetBtn">Select Program Target</button>
                            <span id="programTargetDisplay" style="margin-left: 10px; color: #666; font-style: italic;">Run from RAM</span>
                        </div>
                    </div>
                    <div id="HidModeDiv" style="display: block;">
                        <div>
                            <label>FXCore address (hex WITH leading 0x):</label>
                            <input type="text" id="FXcoreAddr" size="8" value="0x30" style="margin-left: 10px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div><br />
                        <div>
                            <button onclick="cycleProgramTargetWithSave()" id="programTargetBtnHid">Select Program Target</button>
                            <span id="programTargetDisplayHid" style="margin-left: 10px; color: #666; font-style: italic;">Run from RAM</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="download-buttons">
            <!-- Dynamic buttons that change based on mode -->
            <button onclick="downloadHex()" id="downloadHexBtn" disabled>Run from RAM</button>
            <button onclick="exitRunFromRam()" id="exitRamBtn" disabled style="display: inline-block;">Exit Run from RAM</button>
            <div style="float: right;">
                <button onclick="toggleConnection()" id="connectBtn">Connect</button>
                <button onclick="clearHardware()" id="clearHardwareBtn" disabled style="display: none;">Clear Hardware</button>
                <button onclick="clearAssembly()" id="clearResultsBtn">Clear Results</button>
            </div>
        </div>



        <div class="output-text-section">
            <h3 onclick="toggleOutput()" style="cursor: pointer; user-select: none; margin-bottom: 10px;">
                <span id="outputToggle">▶</span> Assembly Output
            </h3>
            <div id="outputContent" class="output-content collapsed">
                <textarea id="output" readonly placeholder="FXCore assembly output will appear here..."></textarea>
            </div>
        </div>

        <div class="instructions-section">
            <h3 onclick="toggleInstructions()" style="cursor: pointer; user-select: none; margin-bottom: 10px;">
                <span id="instructionsToggle">▶</span> Instructions & Help
            </h3>
            <div id="instructionsContent" class="instructions-content collapsed">
                <div class="instructions-text">
                    <div>
                        <h4>Getting Started</h4>
                        <p>This web application is designed to assemble FXCoreASM assembly code into machine instructions. Generated machine code may be saved locally for later use, or sent to a <b>SandboxFX</b> hardware target to hear the results.</p>
                        <ul>
                            <li><i>Enter FXCore source code into the editor area, or select a file or example. Press the <b>Assemble</b> button to verify and assemble the code into a HEX file</i></li>
                            <li><i>Press the <b>Download HEX</b> to save the resulting HEX file to your local Downloads folder. Check the <b>Build Results</b> for success or error messages.</i></li>
                            <li><i><b>Download C Headers</b> outputs the assembled data in a C Header format for use with more advanced applications and is not used with <b>SandboxFX</b> hardware</i></li>
                            <li><i>When satisfied with your source code, press the <b>Save Source...</b> button to download a local copy.</i></li>
                        </ul>
                        <h4>Connecting to Hardware</h4>
                        <p><i>Connect your <b>SandboxFX</b> pedal to your computer using a suitable USB cable. A new removable drive labeled <b>SANDBOX-FX</b> should appear.</i></p>
                        <ul>
                            <li>Press the <b>Connect</b> button, then select the <b>SandboxFX</b> device from the list. You may need to allow this web app to access USB devices.</li>
                            <li><i>Press the <b>Run from RAM</b> button to audition your assembled program on your <b>SandboxFX</b></i></li>
                            <li><i>Press <b>Exit Run from RAM</b> to return to normal operation when finished</i></li>
                            <li><i>Open the <b>Hardware Options</b> panel and tap the <b>Select Program Target</b> to choose one of the 16 available program locations to write. This will save the assembled code to the slot and will persist even if the power is removed.</i></li>
                        </ul>
                        <h4>Troubleshooting</h4>
                        <p>Errors and warnings will appear in the Build Results window and are often helpful for troubleshooting. Scroll up to the top to see previous messages</p>
                        <ul>
                            <li>Error information not helpful</i> - use <b>Editor Options - Show full build results</b> to see more detailed info</li>
                            <li>File transfer problems - <i>ensure proper directory permissions</i></li>
                            <li>Assembly errors - <i>check syntax and register usage</i></li>
                            <li>Connection issues - <i>verify USB cable and HID device selection</i></li>
                        </ul>
                        <h4>What do these Options do?</h4>
                        <p>These are some settings that change various editor and hardware settings</p>
                        <ul>
                            <h3>Editor Options</h3>
                            <li>Large editor window: <i>Expands editor text area to show more instructions</i></li>
                            <li>Enable dark mode: <i>Use dark colour theme, follows system theme</i></li>
                            <li>Show editor mini-map: <i>Show a small navigation map in editor</i></li>
                            <li>Show full build results: <i>Show complete debug information in <b>Build Results</b> window</i></li>
                        </ul>
                        <ul>
                            <h3>Hardware Options</h3>
                            <li>Select Hardware Mode: <i>Toggles communication mode between USB-HID and USB Disk Mode</i></li>
                            <li>File - Select Output Directory: <i>Specify the folder location of your <b>SandboxFX</b> hardware (typically /SANDBOX-FX)</i></li>
                            <li>File - Select Serial Port: <i>Open <b>SandboxFX</b> serial port to allow hardware debugging information</i></li>
                            <li>HID - FXCore address: <i>Set I2C address of FXCore IC, defaults to 0x30</i></li>
                            <li>Select Program Target: <i>Press to select <b>Run from RAM</b> target or a program slot on <b>SandboxFX</b> hardware</i></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Modal dialogs for user prompts -->
            <div id="confirmModal" class="modal">
                <div class="modal-content">
                    <h3 id="confirmTitle">Confirm Action</h3>
                    <p id="confirmMessage">Are you sure you want to proceed?</p>
                    <div class="modal-buttons">
                        <button class="btn-secondary" onclick="closeModal('confirmModal')">Cancel</button>
                        <button class="btn-primary" id="confirmOkBtn">OK</button>
                    </div>
                </div>
            </div>

            <div id="threeChoiceModal" class="modal">
                <div class="modal-content">
                    <h3 id="threeChoiceTitle">Unsaved Changes</h3>
                    <p id="threeChoiceMessage">You have unsaved changes. What would you like to do?</p>
                    <div class="modal-buttons">
                        <button class="btn-secondary" id="threeChoiceCancelBtn">Cancel</button>
                        <button class="btn-danger" id="threeChoiceDiscardBtn">Discard</button>
                        <button class="btn-primary" id="threeChoiceSaveBtn">Save</button>
                    </div>
                </div>
            </div>

            <div id="inputModal" class="modal">
                <div class="modal-content">
                    <h3 id="inputTitle">Input Required</h3>
                    <label for="modalInput" id="inputLabel">Please enter a value:</label>
                    <input type="text" id="modalInput" placeholder="Enter value...">
                    <div class="modal-buttons">
                        <button class="btn-secondary" onclick="closeModal('inputModal')">Cancel</button>
                        <button class="btn-primary" id="inputOkBtn">OK</button>
                    </div>
                </div>
            </div>

            <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 11px; color: #666; line-height: 1.4;">
                <p><strong>MIT License</strong></p>
                <p>FXCore Sandbox Editor by Disaster Area Designs, <a href="https://github.com/DisasterAreaDesigns/Sandbox-FXCore" style="color: #666;">https://github.com/DisasterAreaDesigns/Sandbox-FXCore</a><br>
                    Copyright (c) 2025-present by Disaster Area Designs LLC</p>
                <p>Uses portions of fxcoreasmlite by Experimental Noize, <a href="https://experimentalnoize.com" style="color: #666;">https://experimentalnoize.com</a><br>
                    Copyright (c) 2019-present Experimental Noize</p>
                <p>Uses monaco-editor by Microsoft, <a href="https://github.com/microsoft/monaco-editor" style="color: #666;">https://github.com/microsoft/monaco-editor</a><br>
                    Copyright (c) 2016-present Microsoft Corporation</p>
                <p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
                    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
                    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
                    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
                    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
                    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
                    SOFTWARE.</p>
                <p>This web application stores user settings on this computer in local storage.  We don't collect information or any personal data from our users.</p>
            </footer>

            <!-- FXCore Assembler Scripts -->
            <script src="ui.js"></script>
            <script src="examples.js"></script>
            <script src="debug_config.js"></script>
            <script src="common.js"></script>
            <script src="reserved_words.js"></script>
            <script src="registers.js"></script>
            <script src="mnemonic.js"></script>
            <script src="shunting_yard.js"></script>
            <script src="line_parse.js"></script>
            <script src="intel_hex.js"></script>
            <script src="symbol_table.js"></script>
            <script src="fxcore_ic.js"></script>
            <script src="assembler.js"></script>
            <script src="program.js"></script>
            <script src="FT260_wrap.js"></script>
            <script src="FXCoreProgrammer.js"></script>
            <script src="FXCoreTargets.js"></script>
            <script src="FXCoreFunctions.js"></script>
            <script src="user-preferences.js"></script>

            <script>
                // Global variables and functions to integrate FXCore with Monaco editor
                let assembledData = null;

                FXCoreTargets.FXCore_I2C = 0x30; // default FXCore device address, can be changed in above text input

                // watch for board connection
                navigator.hid.addEventListener('connect', (event) => {
                    console.log(`HID device connected`);
                    updateBuildResultsButtons();
                    updateHardwareConnectionStatus();
                });

                // watch for board disconnection
                navigator.hid.addEventListener('disconnect', (event) => {
                    const device = event.device;
                    if (device === FXCoreTargets.device) {
                        console.log(`FXCore device disconnected`);
                        FXCoreTargets.device = null;
                        // document.getElementById("FXCoreRFRButton").disabled = true;
                        // document.getElementById("FXCoreExitRFRButton").disabled = true;
                        // document.getElementById("FXCorePrgButton").disabled = true;
                        // document.getElementById("FXCoreConnectButton").disabled = false;
                        // document.getElementById('HidDeviceDisplay').textContent = 'Select HID Device';
                        isRunningFromRAM = false; // Reset state on disconnect
                        updateHardwareConnectionStatus(); // update text on main page
                        updateBuildResultsButtons(); // update main buttons
                    }
                });

                // // when user changes FXCore address update it
                // document.getElementById('FXcoreAddr').addEventListener('change', function(event) {
                //     FXCoreTargets.FXCore_I2C = document.getElementById('FXcoreAddr').value;
                //     updateHardwareConnectionStatus(); // Update status when address changes
                // });

                // // when user changes program slot to program update it
                // document.getElementById('FXcorePrgNum').addEventListener('change', function(event) {
                //     FXCoreTargets.FXCore_Prg = document.getElementById('FXcorePrgNum').value;
                // });
                // FXCoreTargets.FXCore_Prg = 0; // default program slot

                // Sync both program target displays
                function syncProgramTargetDisplays() {
                    const display1 = document.getElementById('programTargetDisplay');
                    const display2 = document.getElementById('programTargetDisplayHid');
                    const text = selectedProgram === 'ram' ? 'Run from RAM' : `Program ${selectedProgram}`;

                    if (display1) display1.textContent = text;
                    if (display2) display2.textContent = text;
                }

                // Override the cycleProgramTarget to sync both displays
                const originalCycleProgramTarget = window.cycleProgramTarget;
                window.cycleProgramTarget = function() {
                    originalCycleProgramTarget();
                    syncProgramTargetDisplays();
                };

                // Toggle functions for new sections
                function toggleEditorOptions() {
                    const editorOptionsContent = document.getElementById('editorOptionsContent');
                    const editorOptionsToggle = document.getElementById('editorOptionsToggle');

                    if (editorOptionsContent.classList.contains('collapsed')) {
                        editorOptionsContent.classList.remove('collapsed');
                        editorOptionsToggle.textContent = '▼';
                    } else {
                        editorOptionsContent.classList.add('collapsed');
                        editorOptionsToggle.textContent = '▶';
                    }
                }

                function toggleHardwareOptions() {
                    const hardwareOptionsContent = document.getElementById('hardwareOptionsContent');
                    const hardwareOptionsToggle = document.getElementById('hardwareOptionsToggle');

                    if (hardwareOptionsContent.classList.contains('collapsed')) {
                        hardwareOptionsContent.classList.remove('collapsed');
                        hardwareOptionsToggle.textContent = '▼';
                    } else {
                        hardwareOptionsContent.classList.add('collapsed');
                        hardwareOptionsToggle.textContent = '▶';
                    }
                }

                // Add listener for system dark mode changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    const darkModeToggle = document.getElementById('darkModeToggle');
                    if (darkModeToggle && editor) {
                        darkModeToggle.checked = e.matches;
                        const theme = e.matches ? 'fxcoreDark' : 'fxcoreTheme';
                        monaco.editor.setTheme(theme);
                        document.body.classList.toggle('dark-mode', e.matches);
                    }
                });

                // Initialize the FXCore assembler when the page loads
                document.addEventListener('DOMContentLoaded', function() {
                    DEBUG.reset();
                    // DEBUG.setPreset('basic');
                    // DEBUG.showConfig();

                    // Initialize with HID mode by default
                    selectedHW = 'hid';
                    document.getElementById('HWModeDisplay').textContent = 'HID mode';
                    document.getElementById('FileModeDiv').style.display = 'none';
                    document.getElementById('HidModeDiv').style.display = 'block';

                    updateDownloadButtonText();
                    updateProgramTargetDisplay();
                    updateClearHardwareButton();
                    updateBuildResultsButtons(); // Initialize button states
                    updatePlainHexButton(); // Initialize plain HEX button state
                    updateHardwareConnectionStatus();
                    initializeChangeDetection();
                    syncProgramTargetDisplays(); // Sync both displays on load

                    // Override FXCoreAssembler.logMessage to work with our DOM structure
                    if (typeof FXCoreAssembler !== 'undefined') {
                        FXCoreAssembler.logMessage = function(message, type = 'info') {
                            const timestamp = new Date().toLocaleTimeString();
                            const outputArea = document.getElementById('output');
                            const messagesArea = document.getElementById('messages');

                            // Log to console for debugging
                            console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
                        };
                    }

                    initializePreferences();
                    DEBUG.showConfig();

                    console.log('FXCore assembler libraries loaded');
                });
            </script>
        </div>
</body>

</html>